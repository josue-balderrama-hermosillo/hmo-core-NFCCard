<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Industrial Park ‚Äî Generative Demo</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#FF6A00;
    --ink:#0F172A;
    --ink-soft:#475569;
    --paper:#ffffff;
    --surface:#ffffffE6;
    --stroke:#E5E7EB;
    --shadow:0 10px 30px rgba(2,6,23,.08);
    --radius:20px;
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#FAFBFD;color:var(--ink)}

  /* ===== Hero (same vibe as the other app) ===== */
  .hero{
    position:relative; overflow:hidden;
    background:
      radial-gradient(1200px 680px at 6% -10%, rgba(255,106,0,.16) 0%, rgba(255,106,0,.07) 40%, transparent 60%) no-repeat,
      radial-gradient(900px 520px at 96% -10%, rgba(255,106,0,.10) 0%, transparent 60%) no-repeat,
      linear-gradient(180deg, #fff 0%, #FAFBFD 100%);
    border-bottom:1px solid rgba(2,6,23,.05);
  }
  .hero-inner{max-width:1200px;margin:0 auto;padding:18px 16px 22px;display:grid;grid-template-columns:180px 1fr 180px;gap:14px;align-items:center}
  .brand-left,.brand-right{display:flex;align-items:center}
  .brand-left img,.brand-right img{height:48px;object-fit:contain}
  .center-col{display:flex;flex-direction:column;align-items:center;text-align:center;gap:10px}
  .pill{display:inline-flex;align-items:center;gap:.55rem;background:var(--brand);color:#fff;border-radius:999px;padding:.45rem 1rem;font-weight:800;letter-spacing:.2px;line-height:1;box-shadow:0 2px 6px rgba(255,106,0,.25)}
  .title{margin:0;font-weight:900;letter-spacing:-.02em;font-size:clamp(22px,3.2vw,38px);text-wrap:balance}

  @media (max-width:960px){
    .hero-inner{grid-template-columns:1fr;gap:10px}
    .brand-left,.brand-right{justify-content:center}
  }

  /* ===== Toolbar / controls ===== */
  .wrap{max-width:1200px;margin:0 auto;padding:14px 16px 26px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .controls{display:flex;flex-wrap:wrap;gap:.6rem}
  .control{
    background:var(--paper);border:1px solid var(--stroke);border-radius:14px;padding:.5rem .7rem;
    display:flex;align-items:center;gap:.55rem;box-shadow:0 1px 2px rgba(2,6,23,.03)
  }
  .control label{color:var(--ink-soft);font-size:.9rem}
  .control input[type=range]{width:160px}
  .control input[type=number]{width:86px}
  .pill-sm{background:#fff;border:1px solid var(--stroke);border-radius:999px;padding:.25rem .55rem;font-size:.8rem;white-space:nowrap}

  .btn{border:1px solid var(--stroke);background:linear-gradient(180deg,#fff,#fff9f5);border-radius:999px;padding:.55rem .9rem;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:transparent;color:#fff}
  .btn.secondary{background:#fff}
  .btn:active{transform:translateY(1px)}

  /* Collapsible advanced panel (building types) */
  .panel{border:1px solid var(--stroke);border-radius:16px;background:var(--paper);box-shadow:0 1px 4px rgba(2,6,23,.04)}
  .panel summary{cursor:pointer;padding:.6rem .9rem;font-weight:800;list-style:none}
  .panel summary::-webkit-details-marker{display:none}
  .panel-inner{padding:.6rem .9rem}
  .btype{display:flex;align-items:center;gap:.55rem}
  .bchip{display:inline-flex;align-items:center;gap:.35rem;background:#fff;border:1px solid var(--stroke);border-radius:999px;padding:.25rem .55rem;font-size:.85rem}
  .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem}
  @media (max-width:820px){ .row3{grid-template-columns:1fr} }

  /* ===== Layout cards ===== */
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .col-8{grid-column:span 8}
  .col-4{grid-column:span 4}
  @media(max-width:1000px){.col-8,.col-4{grid-column:span 12}}

  .card{
    background:var(--paper);border:1px solid var(--stroke);border-radius:var(--radius);
    box-shadow:var(--shadow);overflow:hidden;
  }
  .thumb{position:relative;aspect-ratio:16/10;background:#eef2f7}
  canvas{display:block;width:100%;height:100%}

  .kp{padding:.85rem 1rem;border-top:1px solid var(--stroke);font-size:.9rem;color:#475569;display:flex;flex-wrap:wrap;gap:.6rem}
  .badge{background:#0000000d;border:1px solid var(--stroke);border-radius:12px;padding:.28rem .6rem}

  .legend{display:flex;gap:.55rem;flex-wrap:wrap;font-size:.85rem;color:#475569;margin:.6rem 0}
  .k{display:inline-block;width:12px;height:12px;border-radius:2px}
  .k-site{background:#94a3b8}
  .k-road{background:#0f172a}
  .k-block{background:#cbd5e1}
  .k-bldg{background:#0284c7}

  /* Sticky mobile action bar */
  .actionbar{display:none;position:sticky;bottom:0;z-index:50;padding:8px 12px}
  .actionbar .inner{max-width:1200px;margin:0 auto;background:var(--surface);backdrop-filter:blur(8px);
    border:1px solid var(--stroke);border-radius:999px;box-shadow:var(--shadow);display:flex;gap:8px;padding:8px}
  .actionbar .btn{flex:1}
  @media (max-width:1024px){ .actionbar{display:block} }
</style>
</head>
<body>

<!-- ===== HERO ===== -->
<header class="hero">
  <div class="hero-inner">
    <div class="brand-left">
      <img src="https://hermosillo.com/wp-content/uploads/2019/07/hermosillo-experience-matters-logo.svg"
           alt="Hermosillo" onerror="this.style.opacity=.0" />
    </div>
    <div class="center-col">
      <span class="pill">üß≠ Core Innovation ‚Äî Generative Layout</span>
      <h1 class="title">Industrial Park ‚Äî Generative Demo</h1>
    </div>
    <div class="brand-right">
      <img src="https://through-the-interface.typepad.com/.a/6a00d83452464869e202942f9c0b09200c-pi"
           alt="Autodesk University" referrerpolicy="no-referrer" onerror="this.style.opacity=.0" />
    </div>
  </div>
</header>

<div class="wrap">
  <!-- ===== Top controls ===== -->
  <div class="toolbar">
    <div class="controls">
      <div class="control"><label>Site W</label><input id="siteW" type="range" min="200" max="900" step="10" value="600"><span id="siteWv" class="pill-sm">600 m</span></div>
      <div class="control"><label>Site H</label><input id="siteH" type="range" min="200" max="700" step="10" value="400"><span id="siteHv" class="pill-sm">400 m</span></div>
      <div class="control"><label>Perimeter Setback</label><input id="setback" type="range" min="5" max="40" step="1" value="15"><span id="setbackv" class="pill-sm">15 m</span></div>
      <div class="control"><label>Road Width</label><input id="roadW" type="range" min="10" max="40" step="1" value="18"><span id="roadWv" class="pill-sm">18 m</span></div>
      <div class="control"><label>Street Spacing X</label><input id="spX" type="range" min="80" max="250" step="5" value="180"><span id="spXv" class="pill-sm">180 m</span></div>
      <div class="control"><label>Street Spacing Y</label><input id="spY" type="range" min="100" max="300" step="5" value="160"><span id="spYv" class="pill-sm">160 m</span></div>
      <div class="control"><label>Parcel Gap</label><input id="gap" type="range" min="6" max="30" step="1" value="12"><span id="gapv" class="pill-sm">12 m</span></div>
      <div class="control"><label><input id="spineMode" type="checkbox"> Spine mode</label></div>
      <div class="control"><label><input id="allowRot" type="checkbox" checked> Allow rotation</label></div>
    </div>
    <div class="controls">
      <button id="regen" class="btn primary">Generate</button>
      <button id="export" class="btn secondary">Export JSON</button>
    </div>
  </div>

  <!-- Collapsible ‚ÄúBuilding types & mix‚Äù (keeps mobile tidy) -->
  <details class="panel" open>
    <summary>Building types & mix</summary>
    <div class="panel-inner">
      <div class="row3">
        <div class="btype">
          <strong>A</strong>
          <span class="bchip">W <input id="aW" type="number" value="120"> D <input id="aD" type="number" value="80"></span>
          <span class="bchip">% <input id="aP" type="number" value="50"></span>
        </div>
        <div class="btype">
          <strong>B</strong>
          <span class="bchip">W <input id="bW" type="number" value="90"> D <input id="bD" type="number" value="60"></span>
          <span class="bchip">% <input id="bP" type="number" value="30"></span>
        </div>
        <div class="btype">
          <strong>C</strong>
          <span class="bchip">W <input id="cW" type="number" value="60"> D <input id="cD" type="number" value="45"></span>
          <span class="bchip">% <input id="cP" type="number" value="20"></span>
        </div>
      </div>
    </div>
  </details>

  <!-- Legend -->
  <div class="legend">
    <span><i class="k k-site"></i> site</span>
    <span><i class="k k-road"></i> roads</span>
    <span><i class="k k-block"></i> blocks/parcels</span>
    <span><i class="k k-bldg"></i> buildings</span>
  </div>

  <!-- ==== Main grid ==== -->
  <div class="grid">
    <section class="col-8">
      <div class="card">
        <div class="thumb"><canvas id="view"></canvas></div>
        <div class="kp" id="kpis"></div>
      </div>
    </section>
    <aside class="col-4">
      <div class="card">
        <div class="kp" id="mix"></div>
        <div style="padding:1rem">
          <p style="margin:.2rem 0 .8rem;color:#475569">Notes</p>
          <ul style="margin:0 0 1rem 1rem;color:#64748b;line-height:1.4">
            <li>Demo packs rectangular buildings into blocks created by a grid or spine road.</li>
            <li>All parcels touch a road; buildings keep a yard gap between each other and edges.</li>
            <li>‚ÄúAllow rotation‚Äù tries width/depth swap to improve fit.</li>
          </ul>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- Sticky mobile action bar -->
<div class="actionbar">
  <div class="inner">
    <button id="regenSticky" class="btn primary">Generate</button>
    <button id="exportSticky" class="btn secondary">Export JSON</button>
  </div>
</div>

<script>
/* ===== Helpers ===== */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const $ = sel=>document.querySelector(sel);
function valNum(id){ return parseFloat($(id).value); }

// live pill values
['#siteW','#siteH','#setback','#roadW','#spX','#spY','#gap'].forEach(id=>{
  $(id).addEventListener('input', ()=>{
    $('#siteWv').textContent = `${valNum('#siteW')} m`;
    $('#siteHv').textContent = `${valNum('#siteH')} m`;
    $('#setbackv').textContent = `${valNum('#setback')} m`;
    $('#roadWv').textContent = `${valNum('#roadW')} m`;
    $('#spXv').textContent = `${valNum('#spX')} m`;
    $('#spYv').textContent = `${valNum('#spY')} m`;
    $('#gapv').textContent   = `${valNum('#gap')} m`;
  });
});

function params(){
  const mixP = [valNum('#aP'), valNum('#bP'), valNum('#cP')];
  const sum = mixP.reduce((a,b)=>a+b,0) || 1;
  const weights = mixP.map(p=>p/sum);
  return {
    siteW: valNum('#siteW'),
    siteH: valNum('#siteH'),
    setback: valNum('#setback'),
    roadW: valNum('#roadW'),
    spX: valNum('#spX'),
    spY: valNum('#spY'),
    gap: valNum('#gap'),
    spine: $('#spineMode').checked,
    allowRot: $('#allowRot').checked,
    types: [
      {key:'A', w:valNum('#aW'), d:valNum('#aD'), weight:weights[0]},
      {key:'B', w:valNum('#bW'), d:valNum('#bD'), weight:weights[1]},
      {key:'C', w:valNum('#cW'), d:valNum('#cD'), weight:weights[2]},
    ]
  };
}

/* ===== Geometry ===== */
function rect(x,y,w,h){ return {x,y,w,h}; }
function inset(r, m){ return rect(r.x+m, r.y+m, Math.max(0,r.w-2*m), Math.max(0,r.h-2*m)); }

/* ===== Roads ===== */
function layoutRoads(site, p){
  const roads = [];
  if(p.spine){
    const vertical = site.w >= site.h;
    const rw = p.roadW;
    if(vertical){
      const cx = site.x + site.w/2;
      roads.push(rect(cx - rw/2, site.y, rw, site.h));
      for(let y = site.y + p.spY; y < site.y + site.h; y += p.spY){
        roads.push(rect(site.x, y - rw/2, site.w, rw));
      }
    }else{
      const cy = site.y + site.h/2;
      roads.push(rect(site.x, cy - rw/2, site.w, rw));
      for(let x = site.x + p.spX; x < site.x + site.w; x += p.spX){
        roads.push(rect(x - rw/2, site.y, rw, site.h));
      }
    }
  } else {
    for(let x = site.x + p.spX; x < site.x + site.w; x += p.spX){
      roads.push(rect(x - p.roadW/2, site.y, p.roadW, site.h));
    }
    for(let y = site.y + p.spY; y < site.y + site.h; y += p.spY){
      roads.push(rect(site.x, y - p.roadW/2, site.w, p.roadW));
    }
  }
  return roads;
}

/* Split site by roads to form blocks */
function carveBlocks(site, roads){
  let blocks = [site];
  for(const rd of roads){
    const next=[];
    for(const b of blocks){
      if(!(rd.x+rd.w<=b.x || rd.x>=b.x+b.w || rd.y+rd.h<=b.y || rd.y>=b.y+b.h)){
        if(rd.h > rd.w){
          const left = rect(b.x, b.y, rd.x - b.x, b.h);
          const right= rect(rd.x + rd.w, b.y, (b.x+b.w)-(rd.x+rd.w), b.h);
          if(left.w>2 && left.h>2) next.push(left);
          if(right.w>2 && right.h>2) next.push(right);
        } else {
          const top = rect(b.x, b.y, b.w, rd.y - b.y);
          const bot = rect(b.x, rd.y + rd.h, b.w, (b.y+b.h)-(rd.y+rd.h));
          if(top.w>2 && top.h>2) next.push(top);
          if(bot.w>2 && bot.h>2) next.push(bot);
        }
      } else {
        next.push(b);
      }
    }
    blocks = next;
  }
  return blocks;
}

/* ===== Packing ===== */
function weightedPick(types){
  const r = Math.random();
  let acc=0;
  for(const t of types){ acc += t.weight; if(r <= acc) return t; }
  return types[types.length-1];
}
function tryPlace(block, x, y, t, gap, allowRot){
  const opts = allowRot ? [[t.w,t.d],[t.d,t.w]] : [[t.w,t.d]];
  for(const [w,d] of opts){
    if(x + w + gap <= block.w && y + d + gap <= block.h) return {ok:true,w,d};
  }
  return {ok:false};
}
function packBlock(blockRect, types, gap, allowRot){
  const bl = inset(blockRect, gap);
  const placed=[];
  let y = 0;
  const minCell = Math.min(...types.map(t=>Math.min(t.w,t.d)));
  while(y + minCell + gap <= bl.h){
    let x = 0, rowH = 0, watchdog=0;
    while(x + minCell + gap <= bl.w && watchdog<200){
      watchdog++;
      const order=[...types].sort(()=>Math.random()-.5);
      order.unshift(weightedPick(types));
      let placedThis=false;
      for(const tt of order){
        const fit = tryPlace(bl, x, y, tt, gap, allowRot);
        if(fit.ok){
          placed.push({ x: bl.x + x, y: bl.y + y, w: fit.w, d: fit.d, key: tt.key, area: fit.w*fit.d });
          x += fit.w + gap;
          rowH = Math.max(rowH, fit.d);
          placedThis=true; break;
        }
      }
      if(!placedThis){ x += 6; }
    }
    if(rowH<=0) break;
    y += rowH + gap;
  }
  return placed;
}

/* ===== Main generator ===== */
function generate(){
  const p = params();
  const site = {x:0,y:0,w:p.siteW,h:p.siteH};
  const buildArea = inset(site, p.setback);
  const roads = layoutRoads(buildArea, p);
  const blocks = carveBlocks(buildArea, roads).map(b=>inset(b, 2));

  const buildings=[]; const mixCount={A:0,B:0,C:0}; let gfa=0;
  for(const b of blocks){
    const placed = packBlock(b, p.types, p.gap, p.allowRot);
    for(const x of placed){ buildings.push(x); mixCount[x.key]++; gfa += x.area; }
  }

  const siteArea = site.w*site.h;
  const roadArea = roads.reduce((s,r)=>s+r.w*r.h,0);
  const blockArea= blocks.reduce((s,r)=>s+r.w*r.h,0);
  const cov = gfa / (siteArea - roadArea);
  const streetLen = roads.reduce((s,r)=>s + (r.w<r.h ? r.h : r.w),0);
  return { params:p, site, buildArea, roads, blocks, buildings, mixCount, gfa, siteArea, roadArea, blockArea, cov, streetLen };
}

/* ===== Render ===== */
const canvas = $('#view'); const ctx = canvas.getContext('2d');
function fitCanvas(){
  const w = canvas.clientWidth || canvas.parentElement.clientWidth;
  const ar = 16/10;
  canvas.width = w*2; canvas.height = (w/ar)*2;
  canvas.style.height = (w/ar)+'px';
}
function drawRect(r, fill, stroke, lw=1){
  if(!r.w || !r.h) return;
  if(fill){ ctx.fillStyle=fill; ctx.fillRect(r.x, r.y, r.w, r.h); }
  if(stroke){ ctx.strokeStyle=stroke; ctx.lineWidth=lw; ctx.strokeRect(r.x, r.y, r.w, r.h); }
}
function drawModel(m){
  fitCanvas();
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);

  const pad = 40;
  const sx = (W - 2*pad) / m.site.w;
  const sy = (H - 2*pad) / m.site.h;
  const s = Math.min(sx, sy);
  const ox = pad + (W - 2*pad - m.site.w*s)/2;
  const oy = pad + (H - 2*pad - m.site.h*s)/2;

  ctx.save(); ctx.translate(ox, oy);

  // site
  drawRect({x:0,y:0,w:m.site.w*s,h:m.site.h*s}, '#94a3b84d', '#94a3b8', 3);

  // roads
  ctx.fillStyle = '#0f172a';
  m.roads.forEach(r=> ctx.fillRect(r.x*s, r.y*s, r.w*s, r.h*s));

  // blocks
  ctx.fillStyle = '#cbd5e1';
  m.blocks.forEach(r=> ctx.fillRect(r.x*s, r.y*s, r.w*s, r.h*s));

  // buildings
  m.buildings.forEach(b=>{
    ctx.fillStyle = '#0284c7';
    ctx.strokeStyle = '#0369a1';
    ctx.lineWidth = 2;
    ctx.fillRect(b.x*s, b.y*s, b.w*s, b.d*s);
    ctx.strokeRect(b.x*s, b.y*s, b.w*s, b.d*s);
  });

  ctx.restore();
}

/* ===== UI wiring ===== */
function update(){
  const model = generate();
  drawModel(model);

  // KPIs
  const k = [
    `Site: ${(model.siteArea/10000).toFixed(2)} ha`,
    `Roads: ${(model.roadArea/10000).toFixed(2)} ha`,
    `Blocks: ${(model.blockArea/10000).toFixed(2)} ha`,
    `Buildings: ${model.buildings.length} pcs`,
    `GFA: ${(model.gfa).toLocaleString()} m¬≤`,
    `Coverage: ${(model.cov*100).toFixed(1)}%`,
    `Street length: ${model.streetLen.toFixed(0)} m`
  ];
  $('#kpis').innerHTML = k.map(x=>`<span class="badge">${x}</span>`).join(' ');

  // Mix
  const p = params();
  $('#mix').innerHTML = `
    <div style="padding:.6rem 1rem">
      <div class="row3">
        <div class="bchip"><strong>A</strong> ${model.mixCount.A} √ó ${p.types[0].w}√ó${p.types[0].d}</div>
        <div class="bchip"><strong>B</strong> ${model.mixCount.B} √ó ${p.types[1].w}√ó${p.types[1].d}</div>
        <div class="bchip"><strong>C</strong> ${model.mixCount.C} √ó ${p.types[2].w}√ó${p.types[2].d}</div>
      </div>
    </div>`;
}

// bind inputs
[
 '#siteW','#siteH','#setback','#roadW','#spX','#spY','#gap','#spineMode','#allowRot',
 '#aW','#aD','#aP','#bW','#bD','#bP','#cW','#cD','#cP'
].forEach(id=> $(id).addEventListener('input', update));

// buttons (desktop + sticky mobile)
$('#regen').addEventListener('click', update);
$('#regenSticky').addEventListener('click', update);

function doExport(){
  const payload = JSON.stringify(generate(), null, 2);
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([payload],{type:'application/json'}));
  a.download = 'industrial_park_layout.json';
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),500);
}
$('#export').addEventListener('click', doExport);
$('#exportSticky').addEventListener('click', doExport);

// resize
window.addEventListener('resize', update);

/* boot */
['#siteW','#siteH','#setback','#roadW','#spX','#spY','#gap'].forEach(id=>{
  $(id).dispatchEvent(new Event('input'));
});
setTimeout(update, 0);
</script>
</body>
</html>
